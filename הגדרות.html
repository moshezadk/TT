<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>הגדרות - מערכת ת"ת</title>
    <style>
        :root {
            --primary-color: #0A0F2D;
            --accent-color: #C6A94A;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-gray);
            direction: rtl;
        }

        .header {
            background: var(--primary-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-logo {
            height: 40px;
        }

        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .settings-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-card h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .action-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s;
        }

        .primary-btn {
            background: var(--accent-color);
            color: white;
        }

        .secondary-btn {
            background: var(--primary-color);
            color: white;
        }

        .danger-btn {
            background: var(--danger);
            color: white;
        }

        .back-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }

        .users-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #ddd;
            text-align: right;
        }

        .users-table th {
            color: var(--primary-color);
            font-weight: bold;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }

        .status-active {
            background: var(--success);
            color: white;
        }

        .status-inactive {
            background: var(--danger);
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .backup-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .backup-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .backup-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .backup-item:last-child {
            border-bottom: none;
        }

        .backup-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .backup-date {
            font-weight: bold;
            color: var(--primary-color);
        }

        .backup-size {
            color: #666;
            font-size: 0.9rem;
        }

        .backup-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-success {
            background: var(--success);
            color: white;
        }

        .status-warning {
            background: var(--warning);
            color: black;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <img src="logo.png" alt="לוגו ישיבת אוהל יוסף" class="header-logo">
        <a href="דף-הבית.html" class="action-btn back-btn">חזרה לדף הבית</a>
    </header>

    <main class="main-content">
        <div class="settings-grid">
            <!-- ניהול משתמשים -->
            <div class="settings-card">
                <h2><i class="fas fa-users"></i> ניהול משתמשים</h2>
                <button class="action-btn primary-btn" onclick="showAddUserModal()">
                    <i class="fas fa-user-plus"></i>
                    הוסף משתמש חדש
                </button>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>שם משתמש</th>
                            <th>תפקיד</th>
                            <th>סטטוס</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- תוכן הטבלה יתווסף דינמית -->
                    </tbody>
                </table>
            </div>

            <!-- גיבוי ושחזור -->
            <div class="settings-card">
                <h2><i class="fas fa-database"></i> גיבוי ושחזור</h2>
                <div class="backup-header">
                    <div class="form-group">
                        <label>תדירות גיבוי אוטומטי</label>
                        <select id="backup-frequency">
                            <option value="daily">יומי</option>
                            <option value="weekly">שבועי</option>
                            <option value="monthly">חודשי</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>שעת גיבוי</label>
                        <input type="time" id="backup-time" value="12:00">
                    </div>
                    <div class="form-group">
                        <label>שמור גיבויים עד</label>
                        <select id="backup-retention">
                            <option value="7">שבוע</option>
                            <option value="30">חודש</option>
                            <option value="90">3 חודשים</option>
                            <option value="365">שנה</option>
                        </select>
                    </div>
                </div>
                <div class="backup-actions">
                    <button class="action-btn primary-btn" onclick="startBackup()">
                        <i class="fas fa-download"></i>
                        התחל גיבוי ידני
                    </button>
                    <button class="action-btn secondary-btn" onclick="saveBackupSettings()">
                        <i class="fas fa-save"></i>
                        שמור הגדרות גיבוי
                    </button>
                </div>
                <div id="backup-progress" class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>
                <div class="backup-history">
                    <h3>היסטוריית גיבויים</h3>
                    <ul class="backup-list" id="backup-history">
                        <!-- תוכן דינמי -->
                    </ul>
                </div>
            </div>

            <!-- סנכרון -->
            <div class="settings-card">
                <h2><i class="fas fa-sync"></i> סנכרון</h2>
                <div class="form-group">
                    <label>מצב סנכרון</label>
                    <div id="sync-status">מסונכרן</div>
                </div>
                <button class="action-btn primary-btn" onclick="syncNow()">
                    <i class="fas fa-sync"></i>
                    סנכרן עכשיו
                </button>
            </div>

            <!-- הגדרות מערכת -->
            <div class="settings-card">
                <h2><i class="fas fa-cog"></i> הגדרות מערכת</h2>
                <div class="form-group">
                    <label>שם החנות</label>
                    <input type="text" id="store-name" value="חנות ת''ת אוהל יוסף">
                </div>
                <div class="form-group">
                    <label>סף התראת מלאי נמוך</label>
                    <input type="number" id="low-stock-threshold" value="10">
                </div>
                <div class="form-group">
                    <label>מטבע</label>
                    <select id="currency">
                        <option value="ILS">₪ שקל</option>
                        <option value="USD">$ דולר</option>
                    </select>
                </div>
                <button class="action-btn primary-btn" onclick="saveSettings()">
                    <i class="fas fa-save"></i>
                    שמור הגדרות
                </button>
            </div>
        </div>
    </main>

    <!-- מודל הוספת משתמש -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <h2>הוספת משתמש חדש</h2>
            <form id="new-user-form" onsubmit="addNewUser(event)">
                <div class="form-group">
                    <label>שם משתמש</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>סיסמה</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label>תפקיד</label>
                    <select id="role" required>
                        <option value="admin">מנהל</option>
                        <option value="cashier">קופאי</option>
                        <option value="stock">מנהל מלאי</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn back-btn" onclick="closeModal()">ביטול</button>
                    <button type="submit" class="action-btn primary-btn">הוסף משתמש</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // מערכת סנכרון
        const networkManager = {
            deviceId: null,
            connections: new Map(),
            dataChannel: null,
            connectedUsers: new Map(),
            messageCache: new Map(),
            syncQueue: new Map(),
            retryAttempts: new Map(),

            generateDeviceId() {
                return `DEVICE_${Math.random().toString(36).substring(2, 9)}`;
            },
            
            init() {
                this.deviceId = this.generateDeviceId();
                const deviceIdElement = document.getElementById('device-id');
                if (deviceIdElement) {
                    deviceIdElement.textContent = this.deviceId;
                }
                this.setupWebRTC();
                this.startDiscovery();
                this.setupPeriodicSync();
                this.setupOfflineSupport();
            },

            setupWebRTC() {
                const config = { 
                    iceServers: [],
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                };
                
                this.peerConnection = new RTCPeerConnection(config);
                this.setupDataChannel();
                this.handleConnectionEvents();
            },

            setupDataChannel() {
                this.dataChannel = this.peerConnection.createDataChannel("sync", {
                    ordered: true,
                    maxRetransmits: 3
                });

                this.dataChannel.onopen = () => {
                    this.updateStatus('מחובר');
                };
                this.dataChannel.onclose = () => this.updateStatus('מנותק');
                this.dataChannel.onmessage = (event) => this.handleMessage(event.data);
            },

            updateStatus(status) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            },

            setupPeriodicSync() {
                // סנכרון אוטומטי כל 5 דקות
                setInterval(() => {
                    if (this.isConnected() && !this.isSyncing) {
                        this.broadcastSyncRequest();
                    }
                }, 5 * 60 * 1000);
            },

            setupOfflineSupport() {
                window.addEventListener('online', () => {
                    this.updateStatus('מחובר');
                    this.processSyncQueue();
                });

                window.addEventListener('offline', () => {
                    this.updateStatus('לא מחובר');
                });

                // בדיקת מצב התחברות ראשוני
                if (navigator.onLine) {
                    this.updateStatus('מחובר');
                } else {
                    this.updateStatus('לא מחובר');
                }
            },

            processSyncQueue() {
                if (!navigator.onLine) return;

                this.syncQueue.forEach((data, id) => {
                    try {
                        this.broadcast(data);
                        this.syncQueue.delete(id);
                    } catch (error) {
                        console.error('שגיאה בשליחת הודעה מהתור:', error);
                        // ניסיון חוזר מוגבל
                        const retryCount = (this.retryAttempts.get(id) || 0) + 1;
                        if (retryCount <= 3) {
                            this.retryAttempts.set(id, retryCount);
                        } else {
                            // לאחר 3 ניסיונות כושלים, מחיקה מהתור
                            this.syncQueue.delete(id);
                            this.retryAttempts.delete(id);
                        }
                    }
                });
            },

            startDiscovery() {
                // שליחת הודעת נוכחות ראשונית
                this.broadcastPresence();
                
                // שליחת הודעת נוכחות כל 5 שניות
                setInterval(() => {
                    this.broadcastPresence();
                }, 5000);
            },

            broadcastPresence() {
                const message = {
                    type: 'PRESENCE',
                    deviceId: this.deviceId,
                    username: localStorage.getItem('username'),
                    userType: localStorage.getItem('userType'),
                    timestamp: Date.now()
                };
                
                this.broadcast(message);
            },

            handlePresence(message) {
                const { deviceId, username, userType, timestamp } = message;
                // עדכון רשימת המשתמשים המחוברים
                this.connectedUsers.set(deviceId, {
                    username,
                    userType,
                    lastSeen: timestamp,
                    online: true
                });
                
                // עדכון התצוגה
                this.updateConnectedUsersList();
            },

            updateConnectedUsersList() {
                const usersList = document.getElementById('connected-users');
                if (!usersList) return;

                usersList.innerHTML = '';
                this.connectedUsers.forEach((user, deviceId) => {
                    if (deviceId !== this.deviceId) {
                        const li = document.createElement('li');
                        li.className = 'user-item';
                        li.innerHTML = `
                            <span class="user-name">${user.username}</span>
                            <span class="user-type">${user.userType === 'admin' ? 'ראש ת"ת' : 'חבר ת"ת'}</span>
                            <span class="user-status ${user.online ? 'online' : 'offline'}">
                                ${user.online ? 'מחובר' : 'לא מחובר'}
                            </span>
                        `;
                        usersList.appendChild(li);
                    }
                });
            },

            broadcastSyncRequest() {
                this.isSyncing = true;
                const syncData = {
                    type: 'SYNC_REQUEST',
                    deviceId: this.deviceId,
                    timestamp: Date.now(),
                    data: this.collectLocalChanges()
                };

                this.broadcast(syncData);
                
                // הגדרת timeout לסנכרון
                setTimeout(() => {
                    if (this.isSyncing) {
                        this.isSyncing = false;
                        this.updateStatus('סנכרון הסתיים - חלק מהמכשירים לא הגיבו');
                    }
                }, 30000);
            },

            collectLocalChanges() {
                const lastSync = localStorage.getItem('lastSyncTime') || 0;
                const changes = {
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    cards: JSON.parse(localStorage.getItem('cards') || '[]'),
                    inventory: JSON.parse(localStorage.getItem('inventory') || '[]'),
                    transactions: JSON.parse(localStorage.getItem('transactions') || '[]'),
                    timestamp: Date.now()
                };

                // סימון שינויים שנעשו מאז הסנכרון האחרון
                Object.keys(changes).forEach(key => {
                    if (Array.isArray(changes[key])) {
                        changes[key] = changes[key].filter(item => 
                            item.lastModified > lastSync
                        );
                    }
                });

                return changes;
            },

            handleSyncRequest(message) {
                try {
                    const theirChanges = message.data;
                    const ourChanges = this.collectLocalChanges();
                    
                    // מיזוג שינויים
                    const mergedData = this.mergeChanges(ourChanges, theirChanges);
                    
                    // עדכון נתונים מקומי
                    this.applyChanges(mergedData);
                    
                    // שליחת אישור סנכרון
                    this.sendSyncResponse(message.deviceId, {
                        status: 'success',
                        timestamp: Date.now()
                    });

                    // עדכון זמן סנכרון אחרון
                    localStorage.setItem('lastSyncTime', Date.now().toString());
                    
                } catch (error) {
                    console.error('שגיאה בטיפול בבקשת סנכרון:', error);
                    this.sendSyncResponse(message.deviceId, {
                        status: 'error',
                        error: error.message
                    });
                }
            },

            mergeChanges(ours, theirs) {
                const merged = {};
                
                ['users', 'cards', 'inventory', 'transactions'].forEach(key => {
                    merged[key] = this.mergeArrays(ours[key], theirs[key]);
                });

                return merged;
            },

            mergeArrays(arr1 = [], arr2 = []) {
                // מיזוג מערכים עם טיפול בקונפליקטים
                const merged = [...arr1];
                
                arr2.forEach(item2 => {
                    const index = merged.findIndex(item1 => 
                        item1.id === item2.id
                    );
                    
                    if (index === -1) {
                        merged.push(item2);
                    } else if (item2.lastModified > merged[index].lastModified) {
                        merged[index] = item2;
                    }
                });

                return merged;
            },

            applyChanges(changes) {
                Object.entries(changes).forEach(([key, value]) => {
                    if (Array.isArray(value)) {
                        const existing = JSON.parse(localStorage.getItem(key) || '[]');
                        const merged = this.mergeArrays(existing, value);
                        localStorage.setItem(key, JSON.stringify(merged));
                    }
                });

                // עדכון ממשק המשתמש
                this.updateUI();
            },

            updateUI() {
                // עדכון רשימות ותצוגות
                updateUsersList();
                updateBackupHistory();
                
                // עדכון סטטוס סנכרון
                const syncStatus = document.getElementById('sync-status');
                if (syncStatus) {
                    syncStatus.textContent = `סונכרן לאחרונה: ${new Date().toLocaleTimeString()}`;
                }
            },

            isConnected() {
                return this.dataChannel?.readyState === 'open';
            },

            handleConnectionEvents() {
                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.broadcastICECandidate(event.candidate);
                    }
                };

                this.peerConnection.ondatachannel = (event) => {
                    const receiveChannel = event.channel;
                    receiveChannel.onmessage = (e) => this.handleMessage(e.data);
                };
            },

            broadcastICECandidate(candidate) {
                if (this.dataChannel?.readyState === 'open') {
                    this.dataChannel.send(JSON.stringify({
                        type: 'ICE_CANDIDATE',
                        candidate
                    }));
                }
            },

            broadcast(data) {
                if (this.dataChannel?.readyState === 'open') {
                    this.dataChannel.send(JSON.stringify(data));
                } else {
                    // שמירה בתור לשליחה מאוחרת
                    const id = `${Date.now()}_${Math.random()}`;
                    this.syncQueue.set(id, data);
                }
            },

            sendSyncResponse(deviceId, response) {
                this.broadcast({
                    type: 'SYNC_RESPONSE',
                    deviceId: this.deviceId,
                    targetDevice: deviceId,
                    ...response
                });
            },
            
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    
                    switch(message.type) {
                        case 'PRESENCE':
                            this.handlePresence(message);
                            break;
                        case 'SYNC_REQUEST':
                            this.handleSyncRequest(message);
                            break;
                        case 'ICE_CANDIDATE':
                            this.handleICECandidate(message);
                            break;
                        default:
                            console.warn('סוג הודעה לא מוכר:', message.type);
                    }
                } catch (error) {
                    console.error('שגיאה בעיבוד הודעה:', error);
                }
            },

            handleICECandidate(message) {
                try {
                    const candidate = new RTCIceCandidate(message.candidate);
                    this.peerConnection.addIceCandidate(candidate);
                } catch (error) {
                    console.error('שגיאה בהוספת ICE candidate:', error);
                }
            },
        };

        function syncNow() {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.textContent = 'מסנכרן...';
            
            try {
                // בדיקת זמינות רשת
                if (!navigator.onLine) {
                    throw new Error('אין חיבור לרשת');
                }

                // שליחת בקשת סנכרון לכל המכשירים המחוברים
                networkManager.broadcastSyncRequest();
                
                // עדכון ממשק המשתמש
                updateSyncStatus('success');
            } catch (error) {
                console.error('שגיאת סנכרון:', error);
                updateSyncStatus('error', error.message);
            }
        }

        function updateSyncStatus(status, message = '') {
            const syncStatus = document.getElementById('sync-status');
            if (!syncStatus) return;

            switch (status) {
                case 'success':
                    syncStatus.textContent = `סונכרן בהצלחה: ${new Date().toLocaleTimeString()}`;
                    syncStatus.className = 'success';
                    break;
                case 'error':
                    syncStatus.textContent = `שגיאת סנכרון: ${message}`;
                    syncStatus.className = 'error';
                    break;
                case 'syncing':
                    syncStatus.textContent = 'מסנכרן...';
                    syncStatus.className = 'syncing';
                    break;
            }
        }

        // ניהול משתמשים
        function addUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            
            if (!username || !password) {
                alert('נא למלא את כל השדות');
                return;
            }

            const users = JSON.parse(localStorage.getItem('authorizedUsers') || '[]');
            if (users.some(u => u.username === username)) {
                alert('שם משתמש כבר קיים');
                return;
            }

            users.push({
                username,
                password,
                type: 'staff',
                permissions: {
                    register: true,
                    inventory: false,
                    reports: true,
                    settings: false
                }
            });

            localStorage.setItem('authorizedUsers', JSON.stringify(users));
            updateUsersList();
            alert('המשתמש נוסף בהצלחה');
        }

        // נתוני משתמשים לדוגמה
        let users = [
            {
                username: 'חננאל',
                role: 'admin',
                status: 'active'
            }
        ];

        // נתוני גיבויים לדוגמה
        const backupHistory = [
            {
                date: '2024-01-20 12:00',
                size: '250MB',
                status: 'success',
                type: 'auto'
            },
            {
                date: '2024-01-19 15:30',
                size: '248MB',
                status: 'success',
                type: 'manual'
            },
            {
                date: '2024-01-18 12:00',
                size: '245MB',
                status: 'warning',
                type: 'auto'
            }
        ];

        function updateUsersList() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.username}</td>
                    <td>${getRoleName(user.role)}</td>
                    <td>
                        <span class="status-badge status-${user.status}">
                            ${user.status === 'active' ? 'פעיל' : 'לא פעיל'}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn" onclick="editUser('${user.username}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn danger-btn" onclick="deleteUser('${user.username}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'מנהל',
                'cashier': 'קופאי',
                'stock': 'מנהל מלאי'
            };
            return roles[role] || role;
        }

        function showAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('add-user-modal').style.display = 'none';
        }

        function addNewUser(event) {
            event.preventDefault();
            
            const newUser = {
                username: document.getElementById('username').value,
                role: document.getElementById('role').value,
                status: 'active'
            };

            users.push(newUser);
            closeModal();
            updateUsersList();
        }

        function updateBackupHistory() {
            const historyList = document.getElementById('backup-history');
            if (!historyList) return;

            const backups = JSON.parse(localStorage.getItem('backups') || '[]');
            const restores = JSON.parse(localStorage.getItem('restores') || '[]');

            historyList.innerHTML = '';

            // מיזוג ומיון של גיבויים ושחזורים
            const allOperations = [
                ...backups.map(b => ({...b, type: 'backup'})),
                ...restores.map(r => ({...r, type: 'restore'}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            allOperations.forEach(operation => {
                const li = document.createElement('li');
                li.className = 'backup-item';
                
                const date = new Date(operation.timestamp);
                const formattedDate = date.toLocaleString('he-IL');
                
                if (operation.type === 'backup') {
                    li.innerHTML = `
                        <span class="backup-date">${formattedDate}</span>
                        <span class="backup-type">גיבוי</span>
                        <span class="backup-size">${formatFileSize(operation.size)}</span>
                        <span class="backup-status ${operation.status}">${getStatusText(operation.status)}</span>
                    `;
                } else {
                    li.innerHTML = `
                        <span class="backup-date">${formattedDate}</span>
                        <span class="backup-type">שחזור</span>
                        <span class="backup-status ${operation.status}">${getStatusText(operation.status)}</span>
                    `;
                }
                
                historyList.appendChild(li);
            });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('he-IL');
        }

        function getStatusText(status) {
            const statusMap = {
                'success': 'הושלם',
                'warning': 'אזהרה',
                'error': 'שגיאה'
            };
            return statusMap[status] || status;
        }

        function saveBackupSettings() {
            const settings = {
                frequency: document.getElementById('backup-frequency').value,
                time: document.getElementById('backup-time').value,
                retention: document.getElementById('backup-retention').value
            };
            
            console.log('Saving backup settings:', settings);
            alert('הגדרות הגיבוי נשמרו בהצלחה!');
        }

        function startBackup() {
            const timestamp = new Date().toISOString();
            const backupData = {
                timestamp: timestamp,
                users: localStorage.getItem('users'),
                cards: localStorage.getItem('cards'),
                inventory: localStorage.getItem('inventory'),
                transactions: localStorage.getItem('transactions'),
                settings: localStorage.getItem('settings'),
                version: '1.0'
            };

            // יצירת קובץ גיבוי
            const backupStr = JSON.stringify(backupData);
            const blob = new Blob([backupStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // הורדת הקובץ
            const a = document.createElement('a');
            const fileName = `TTT_backup_${timestamp.replace(/:/g, '-')}.json`;
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // שמירת היסטוריית גיבויים
            const backups = JSON.parse(localStorage.getItem('backups') || '[]');
            backups.push({
                timestamp: timestamp,
                fileName: fileName,
                size: backupStr.length,
                status: 'completed'
            });
            localStorage.setItem('backups', JSON.stringify(backups));
            
            updateBackupHistory();
            alert('הגיבוי הושלם בהצלחה!');
        }

        function restoreBackup(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // בדיקת תקינות הגיבוי
                    if (!backupData.version || !backupData.timestamp) {
                        throw new Error('קובץ הגיבוי אינו תקין');
                    }

                    // גיבוי נוכחי לפני השחזור
                    const currentData = {
                        users: localStorage.getItem('users'),
                        cards: localStorage.getItem('cards'),
                        inventory: localStorage.getItem('inventory'),
                        transactions: localStorage.getItem('transactions'),
                        settings: localStorage.getItem('settings')
                    };
                    localStorage.setItem('backup_before_restore', JSON.stringify(currentData));

                    // שחזור הנתונים
                    if (backupData.users) localStorage.setItem('users', backupData.users);
                    if (backupData.cards) localStorage.setItem('cards', backupData.cards);
                    if (backupData.inventory) localStorage.setItem('inventory', backupData.inventory);
                    if (backupData.transactions) localStorage.setItem('transactions', backupData.transactions);
                    if (backupData.settings) localStorage.setItem('settings', backupData.settings);

                    // עדכון היסטוריית שחזורים
                    const restores = JSON.parse(localStorage.getItem('restores') || '[]');
                    restores.push({
                        timestamp: new Date().toISOString(),
                        backupDate: backupData.timestamp,
                        status: 'completed'
                    });
                    localStorage.setItem('restores', JSON.stringify(restores));

                    alert('השחזור הושלם בהצלחה! המערכת תתרענן כעת.');
                    location.reload();
                } catch (error) {
                    console.error('שגיאה בשחזור:', error);
                    alert('שגיאה בשחזור: ' + error.message);
                    
                    // שחזור הנתונים הקודמים במקרה של שגיאה
                    const previousData = JSON.parse(localStorage.getItem('backup_before_restore') || '{}');
                    Object.entries(previousData).forEach(([key, value]) => {
                        if (value) localStorage.setItem(key, value);
                    });
                }
            };

            reader.readAsText(file);
        }

        function updateBackupHistory() {
            const backupsList = document.getElementById('backup-list');
            if (!backupsList) return;

            const backups = JSON.parse(localStorage.getItem('backups') || '[]');
            const restores = JSON.parse(localStorage.getItem('restores') || '[]');

            backupsList.innerHTML = '';
            
            // מיזוג ומיון של גיבויים ושחזורים
            const allOperations = [
                ...backups.map(b => ({...b, type: 'backup'})),
                ...restores.map(r => ({...r, type: 'restore'}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            allOperations.forEach(operation => {
                const li = document.createElement('li');
                li.className = 'backup-item';
                
                const date = new Date(operation.timestamp);
                const formattedDate = date.toLocaleString('he-IL');
                
                if (operation.type === 'backup') {
                    li.innerHTML = `
                        <span class="backup-date">${formattedDate}</span>
                        <span class="backup-type">גיבוי</span>
                        <span class="backup-size">${formatFileSize(operation.size)}</span>
                        <span class="backup-status ${operation.status}">${getStatusText(operation.status)}</span>
                    `;
                } else {
                    li.innerHTML = `
                        <span class="backup-date">${formattedDate}</span>
                        <span class="backup-type">שחזור</span>
                        <span class="backup-status ${operation.status}">${getStatusText(operation.status)}</span>
                    `;
                }
                
                backupsList.appendChild(li);
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function syncNow() {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.textContent = 'מסנכרן...';
            
            // סימולציה של תהליך הסנכרון
            setTimeout(() => {
                syncStatus.textContent = 'מסונכרן';
                alert('הסנכרון הושלם בהצלחה!');
            }, 2000);
        }

        function saveSettings() {
            const settings = {
                storeName: document.getElementById('store-name').value,
                lowStockThreshold: document.getElementById('low-stock-threshold').value,
                currency: document.getElementById('currency').value
            };
            
            // שמירת ההגדרות
            console.log('Saving settings:', settings);
            alert('ההגדרות נשמרו בהצלחה!');
        }

        function deleteUser(username) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את המשתמש ${username}?`)) {
                const userIndex = users.findIndex(user => user.username === username);
                if (userIndex !== -1) {
                    users.splice(userIndex, 1);
                    localStorage.setItem('users', JSON.stringify(users));
                    updateUsersList();
                }
            }
        }

        function editUser(username) {
            const user = users.find(user => user.username === username);
            if (!user) return;

            // פתיחת המודל עם נתוני המשתמש
            const modal = document.getElementById('add-user-modal');
            const form = modal.querySelector('form');
            
            // מילוי הטופס בנתוני המשתמש
            form.querySelector('#username').value = user.username;
            form.querySelector('#password').value = user.password;
            form.querySelector('#role').value = user.role;
            
            // שינוי כפתור השמירה
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'עדכון משתמש';
            
            // שמירת המשתמש המקורי לעדכון
            form.dataset.editingUser = username;
            
            // הצגת המודל
            modal.style.display = 'block';
            
            // עדכון הטיפול בשליחת הטופס
            form.onsubmit = function(event) {
                event.preventDefault();
                
                const updatedUser = {
                    username: form.querySelector('#username').value,
                    password: form.querySelector('#password').value,
                    role: form.querySelector('#role').value
                };
                
                // עדכון המשתמש במערך
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex !== -1) {
                    users[userIndex] = updatedUser;
                    localStorage.setItem('users', JSON.stringify(users));
                    updateUsersList();
                }
                
                // סגירת המודל
                closeModal();
                
                // איפוס הטופס
                form.reset();
                submitBtn.textContent = 'הוספת משתמש';
                delete form.dataset.editingUser;
            };
        }

        // אתחול הדף
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('userType') === 'admin') {
                networkManager.init();
            }
            updateUsersList();
            updateBackupHistory();
        });
    </script>
</body>
</html>